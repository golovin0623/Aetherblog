# 🐛 故障归档: Admin 生产环境 404/502 问题

- **日期**: 2026-01-08
- **组件**: Admin Frontend (Vite + Nginx)
- **环境**: Production (Docker)
- **严重程度**: 🔴 高 (导致后台无法访问)

## 📍 问题描述
Admin 服务在开发环境 (localhost:5173) 运行正常，但在生产环境通过 Nginx 网关访问 (`/admin/`) 时：
1. **静态资源 404**: JS/CSS 文件加载失败 (`net::ERR_ABORTED 404`)。
2. **页面 502**: 网关返回 `502 Bad Gateway`。

## 🔍以此为戒 Root Cause (根本原因)

**Nginx `location` 优先级陷阱**：
在 `apps/admin/nginx.conf` 中，存在两个主要的 location 块：
1. `location /admin`: 用于处理前缀请求 (使用了 `rewrite`)。
2. `location ~* \.(js|css|...)$`: 用于全局静态资源缓存 (正则匹配)。

**Nginx 规则**: **正则匹配 (`~`) 优先级高于普通前缀匹配 (`/admin`)**。

当请求 `/admin/assets/index.js` 时：
- Nginx **优先** 匹配了 `~* \.js$` 规则。
- 该规则没有配置 `rewrite`，直接在 `root /usr/share/nginx/html` 下寻找 `/admin/assets/index.js`。
- 实际文件位于 `/usr/share/nginx/html/assets/index.js`。
- **结果**: 路径错误 -> 404 Not Found。

## 🛠️ 解决方案

使用 `^~` 修饰符强制 **前缀匹配优先**，禁止正则抢占。

```nginx
# ✅ 正确配置
location ^~ /admin/assets/ {
    # 1. ^~ 确保匹配到此块后，停止搜索后续的正则匹配
    # 2. 剥离 /admin 前缀
    rewrite ^/admin/(.*)$ /$1 break;
    root /usr/share/nginx/html;
    expires 1y;
}
```

## 📜 经验总结 (Lessons Learned)

1. **不要在生产环境使用 `alias`**: 它与 `try_files` 结合时有极其复杂的 Bug (Round 1 失败原因)。
2. **警惕正则优先级**: 如果有全局的 `location ~ \.xxx`，必须小心它会 "抢走" 带有特定前缀的请求。
3. **使用 `^~` 保护前缀**: 对于需要特殊处理路径 (如 rewrite) 的静态资源，务必使用 `^~` 锁定。

## 🔗 相关变更
- `apps/admin/nginx.conf`: v1.1.9 修复
- `docker-compose.prod.yml`: 涉及版本覆盖部署
