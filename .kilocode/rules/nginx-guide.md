---
trigger: model_decision
description: Nginx é…ç½®æœ€ä½³å®è·µæŒ‡å—
---

# ğŸš€ Nginx é…ç½®æœ€ä½³å®è·µæŒ‡å—

> **æœ€åæ›´æ–°**: 2026-01-08  
> **ç›¸å…³æ•…éšœ**: Admin 404/502 Incident (2026-01-08)

## 1. æ ¸å¿ƒåŸåˆ™ï¼šå‰ç¼€è·¯ç”±ä¼˜å…ˆ (Prefix Routing)

åœ¨å•é¡µé¢åº”ç”¨ (SPA) éƒ¨ç½²ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°† `/admin` ç­‰å­è·¯å¾„è·¯ç”±åˆ°ç‰¹å®šçš„æ ¹ç›®å½•ã€‚

### ğŸ›‘ é™·é˜±ï¼šæ­£åˆ™ä¼˜å…ˆ (Regex Precedence)
Nginx çš„é»˜è®¤è¡Œä¸ºæ˜¯ï¼š**æ­£åˆ™è¡¨è¾¾å¼ (`~`) çš„ä¼˜å…ˆçº§é«˜äºæ™®é€šå‰ç¼€åŒ¹é… (`/`)**ã€‚

**é”™è¯¯ç¤ºä¾‹**:
```nginx
# 1. å‰ç¼€åŒ¹é…
location /admin {
    rewrite ^/admin(.*)$ $1 break;
    # ...
}

# 2. å…¨å±€ JS ç¼“å­˜ (æ­£åˆ™)
# ğŸ’€ è‡´å‘½: è¯·æ±‚ /admin/assets/app.js æ—¶ï¼Œè¿™ä¸ªæ­£åˆ™ä¼šæŠ¢å ï¼
# å¯¼è‡´ Nginx å¿½ç•¥ä¸Šé¢çš„ rewriteï¼Œå»é”™è¯¯çš„è·¯å¾„æ‰¾æ–‡ä»¶ã€‚
location ~* \.js$ {
    expires 1y;
}
```

### âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ `^~`

ä½¿ç”¨ `^~` ä¿®é¥°ç¬¦å‘Šè¯‰ Nginxï¼š**"åªè¦åŒ¹é…äº†è¿™ä¸ªå‰ç¼€ï¼Œç«‹åˆ»åœæ­¢æœç´¢æ­£åˆ™è§„åˆ™ï¼"**

**æ­£ç¡®ç¤ºä¾‹**:
```nginx
# ğŸ”’ é”å®šå‰ç¼€ï¼Œé˜²æ­¢æ­£åˆ™æŠ¢å 
location ^~ /admin/assets/ {
    rewrite ^/admin/(.*)$ /$1 break;
    root /usr/share/nginx/html;
    expires 1y;
}

location ^~ /admin/ {
    rewrite ^/admin/(.*)$ /$1 break;
    root /usr/share/nginx/html;
    try_files $uri $uri/ /index.html;
}
```

---

## 2. æ ¸å¿ƒåŸåˆ™ï¼šæ…ç”¨ `alias`

åœ¨é…åˆ `try_files` æ—¶ï¼Œå°½é‡é¿å…ä½¿ç”¨ `alias`ã€‚

### ğŸ›‘ é™·é˜±ï¼šAlias + Try_files Bug
`alias` åœ¨å¤„ç†åµŒå¥— location æˆ–æ­£åˆ™åŒ¹é…æ—¶ï¼Œç»å¸¸å‡ºç°è·¯å¾„æ‹¼æ¥é”™è¯¯ï¼Œæˆ–è€… `try_files` æ— æ³•æ­£ç¡®å›é€€ã€‚

**ä¸æ¨è**:
```nginx
location /admin {
    alias /usr/share/nginx/html;
    try_files $uri $uri/ /index.html; # é£é™©æé«˜
}
```

### âœ… è§£å†³æ–¹æ¡ˆï¼šRoot + Rewrite

ä½¿ç”¨ `root` æŒ‡å®šæ ¹ç›®å½•ï¼Œé…åˆ `rewrite` ç§»é™¤ URL å‰ç¼€ï¼Œè¿™ç§æ–¹å¼æœ€ç¨³å¥ã€‚

**æ¨è**:
```nginx
location /admin {
    rewrite ^/admin(.*)$ $1 break; # å‰¥ç¦»å‰ç¼€
    root /usr/share/nginx/html;    # æ˜ç¡®æ ¹ç›®å½•
    try_files $uri $uri/ /index.html;
}
```

---

## 3. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ç¡®ä¿æ‰€æœ‰äºŒçº§ç›®å½• (`/admin`, `/blog`) éƒ½ä½¿ç”¨äº† `^~` ä¿æŠ¤ã€‚
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€ `location ~` è§„åˆ™å¯èƒ½å†²çªã€‚
- [ ] éªŒè¯é™æ€èµ„æº (JS/CSS) æ˜¯å¦èƒ½æ­£ç¡®åŠ è½½ (`curl -I ...`).
- [ ] éªŒè¯ SPA åˆ·æ–°æ˜¯å¦æ­£å¸¸ (å›é€€åˆ° index.html).
