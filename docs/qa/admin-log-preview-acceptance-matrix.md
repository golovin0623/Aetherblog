# Admin 日志预览基线与统一验收矩阵

更新时间：2026-02-14

## 1. 目标与范围
- 目标：统一 Dashboard 与 System Monitor 两处日志入口的能力语义、复测路径与失败判定。
- 入口 A（Dashboard）：`apps/admin/src/pages/dashboard/DashboardPage.tsx` 的系统监控区日志面板。
- 入口 B（Monitor）：`apps/admin/src/pages/MonitorPage.tsx` 的日志面板。
- 共同实现：`apps/admin/src/pages/dashboard/components/RealtimeLogViewer.tsx`。

## 2. 现状问题清单（基线）
1. 状态语义分散：组件内部既有 `loading/paused/autoScroll/isFullScreen`，又有 `logStatus`，缺少统一状态机约束。
2. 自动刷新治理不足：仅有固定间隔轮询，不支持页面隐藏自动暂停、错误退避重试、恢复后增量策略。
3. 全屏可访问性不足：未支持 `Esc` 退出、焦点管理和背景滚动锁定。
4. 阅读能力不足：缺少关键字筛选、紧凑/换行模式切换、序号与时间辅助信息。
5. 导出能力单一：仅支持按日志级别下载，未覆盖“按当前筛选导出”“最近 N 行导出”。
6. 接口契约偏弱：应用日志接口仅 `level + lines`，缺少 `keyword/limit/cursor` 等高级参数与统一错误分类输出。

## 3. 六类能力统一验收矩阵

| 能力类 | 复测路径（Dashboard） | 复测路径（Monitor） | 预期结果 | 失败判定 |
|---|---|---|---|---|
| 显示与状态 | 打开 Dashboard → 系统监控 → 日志面板 | 打开 Monitor → 日志面板 | 状态文案与标识一致；`healthy/no_data/error/paused/fullscreen` 语义一致 | 同状态文案不一致；暂停中仍显示“运行正常”且持续请求 |
| 筛选与查询 | 切换级别（ALL/INFO/WARN/ERROR/DEBUG）并观察列表 | 同左 | 两入口筛选行为一致，切换后数据刷新且无错位 | 切换后不刷新、错刷、与当前筛选不一致 |
| 下载与导出 | 点击下载并核对文件名、内容范围 | 同左 | 下载动作可用；无数据或错误时禁用/提示明确 | 下载按钮不可用但无提示；文件名或内容与筛选不一致 |
| 全屏与沉浸 | 点击全屏/退出按钮 | 同左 | 进入/退出全屏正常；遮罩层级正确；退出后状态恢复 | 遮罩穿透、无法退出、退出后布局或状态丢失 |
| 自动刷新治理 | 观察自动刷新、暂停/继续、手动刷新 | 同左 | 暂停后无轮询；恢复后可继续；“最近成功”可更新 | 暂停后仍请求；恢复无效；最近成功时间不更新 |
| 异常与空数据 | 触发无日志、服务异常场景 | 同左 | `no_data` 与 `error` 呈现差异明确，附错误分类 | 统一报错文案；无法区分空数据与错误 |

## 4. 统一复测清单（可复现）
1. 进入两入口，确认默认状态为“初始化中”，成功后为“运行正常”。
2. 切换日志级别到 `ERROR`，观察两入口结果一致。
3. 点击暂停，等待两倍刷新周期，确认无新增请求后再继续。
4. 点击手动刷新，确认“最近成功”时间更新。
5. 触发空日志文件场景，确认展示 `no_data` 提示与错误分类。
6. 触发日志读取异常场景，确认展示 `error` 提示与错误分类。
7. 进入全屏后点击遮罩退出，确认退出后面板状态与滚动位置符合预期。
8. 点击下载（有数据/无数据两种）验证文件获取和失败反馈。

## 5. 后续开发约束
- 新增日志能力（筛选/导出/状态）必须先补充本矩阵，再进入编码。
- Dashboard 与 Monitor 任一入口新增行为，必须在另一入口同步验证。
- 回归记录需附至少一种证据：命令输出、接口返回、截图路径或录屏链接。

## 6. 发布回归与回退入口
- 发布前按 `docs/qa/admin-log-preview-release-guard-2026-02-14.md` 执行分层回归（组件交互/契约/性能基线）。
- 灰度发布优先 Dashboard 小流量，再逐步覆盖 Monitor，异常时先关闭导出与契约扩展能力。
- 需要快速止损时，直接执行回退预案中的 `git revert --no-edit` 命令并复跑构建与契约测试。

