# =============================================================================
# AetherBlog Nginx Gateway - 开发模式配置
# =============================================================================
# 用于开发环境，指向 localhost 端口
# 使用方式: 通过 Docker 启动，映射到 7899 端口
#
# 与 nginx.conf (生产配置) 的区别:
#   - 使用 host.docker.internal 而非 Docker 服务名
#   - Admin 代理到 :5173 (Vite dev server) 而非 :80 (Nginx静态服务)
#   - 支持 Vite HMR WebSocket
# =============================================================================

# WebSocket 连接升级映射
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# 上游服务定义 (开发模式 - 指向本机端口)
upstream blog_dev {
    server host.docker.internal:3000;  # 本机 Next.js dev server
    keepalive 32;
}

upstream admin_dev {
    server host.docker.internal:5173;  # 本机 Vite dev server
    keepalive 16;
}

upstream backend_dev {
    server host.docker.internal:8080;  # 本机 Spring Boot
    keepalive 64;
}

server {
    listen 80;
    server_name _;
    
    # =========================================================================
    # 基础配置
    # =========================================================================
    
    client_max_body_size 100M;
    client_body_buffer_size 10M;
    client_body_timeout 300s;
    send_timeout 300s;
    
    # 代理缓冲 (关闭以支持 SSE)
    proxy_buffering off;
    
    # 通用代理头
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # HTTP/1.1 支持 keepalive
    proxy_http_version 1.1;
    
    # =========================================================================
    # 管理后台 /admin (开发模式 - Vite dev server)
    # =========================================================================
    
    # /admin 重定向到 /admin/
    location = /admin {
        return 301 /admin/;
    }
    
    # Admin 主应用 - 路径重写代理到 Vite dev server
    location /admin/ {
        # 去掉 /admin 前缀，代理到 Vite (开发模式 base: '/')
        rewrite ^/admin/(.*)$ /$1 break;
        proxy_pass http://admin_dev;
        
        # WebSocket 支持 (Vite HMR)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # =========================================================================
    # AI 流式响应 (SSE - Server-Sent Events)
    # =========================================================================
    location ~ ^/api/(ai|chat|stream) {
        proxy_pass http://backend_dev;
        
        # SSE 必需配置
        proxy_set_header Host localhost:8080;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        
        # 长时间超时 (AI 可能处理很久)
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        chunked_transfer_encoding on;
        add_header X-Accel-Buffering no;
    }
    
    # =========================================================================
    # WebSocket 连接 (实时 AI 对话)
    # =========================================================================
    location ~ ^/api/(ws|websocket|socket) {
        proxy_pass http://backend_dev;
        
        proxy_set_header Host localhost:8080;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;
        
        proxy_buffering off;
    }
    
    # =========================================================================
    # 文件上传
    # =========================================================================
    location ~ ^/api/(upload|media|file) {
        proxy_pass http://backend_dev;
        proxy_set_header Host localhost:8080;
        proxy_set_header Connection "";
        
        client_max_body_size 500M;
        client_body_buffer_size 50M;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        proxy_request_buffering off;
    }
    
    # =========================================================================
    # 后端 API - 常规请求
    # =========================================================================
    location /api {
        proxy_pass http://backend_dev;
        proxy_set_header Host localhost:8080;  # 使用 localhost 避免验证问题
        proxy_set_header Connection "";
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # =========================================================================
    # Next.js 静态资源和 HMR
    # =========================================================================
    location /_next {
        proxy_pass http://blog_dev;
        
        # WebSocket 支持 (Next.js HMR)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
    
    # =========================================================================
    # 博客前台 (默认)
    # =========================================================================
    location / {
        proxy_pass http://blog_dev;
        
        # WebSocket 支持 (Next.js HMR)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # =========================================================================
    # 健康检查
    # =========================================================================
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }
    
    # 错误页面
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}
