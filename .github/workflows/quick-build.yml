name: Quick Docker Build

# 简化版工作流 - 仅构建和推送,跳过测试
# 适用于紧急修复或快速迭代

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build (backend/blog/admin/all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - ai-service
          - blog
          - admin
      version:
        description: 'Version tag (e.g., v1.0.0 or hotfix-xxx)'
        required: true
        default: 'latest'

env:
  DOCKER_REGISTRY: ${{ secrets.DOCKER_USERNAME || 'golovin0623' }}

jobs:
  build-all:
    if: ${{ github.event.inputs.service == 'all' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: backend
            dockerfile: ./apps/server/Dockerfile
          - service: ai-service
            dockerfile: ./apps/ai-service/Dockerfile
          - service: blog
            dockerfile: ./apps/blog/Dockerfile
          - service: admin
            dockerfile: ./apps/admin/Dockerfile
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/aetherblog-${{ matrix.service }}:${{ github.event.inputs.version }}
            ${{ env.DOCKER_REGISTRY }}/aetherblog-${{ matrix.service }}:latest
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/aetherblog-${{ matrix.service }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/aetherblog-${{ matrix.service }}:buildcache,mode=max

  build-single:
    if: ${{ github.event.inputs.service != 'all' }}
    runs-on: ubuntu-latest
    env:
      DOCKERFILE: ${{ fromJSON('{"backend":"./apps/server/Dockerfile","ai-service":"./apps/ai-service/Dockerfile","blog":"./apps/blog/Dockerfile","admin":"./apps/admin/Dockerfile"}')[github.event.inputs.service] }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push ${{ github.event.inputs.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/aetherblog-${{ github.event.inputs.service }}:${{ github.event.inputs.version }}
            ${{ env.DOCKER_REGISTRY }}/aetherblog-${{ github.event.inputs.service }}:latest
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/aetherblog-${{ github.event.inputs.service }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/aetherblog-${{ github.event.inputs.service }}:buildcache,mode=max

      - name: Success notification
        run: |
          echo "✅ Successfully built and pushed:"
          echo "   ${{ env.DOCKER_REGISTRY }}/aetherblog-${{ github.event.inputs.service }}:${{ github.event.inputs.version }}"
          echo "   ${{ env.DOCKER_REGISTRY }}/aetherblog-${{ github.event.inputs.service }}:latest"
